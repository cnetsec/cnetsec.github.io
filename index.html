<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hall de CVEs - South America</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 2rem;
      color: #222;
    }

    .container {
      max-width: 960px;
      margin: auto;
      background: #fff;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }

    .banner {
      font-size: 0.9rem;
      color: #555;
      background: #eef2f5;
      border-left: 4px solid #336699;
      padding: 0.8rem 1rem;
      margin-bottom: 1.5rem;
      border-radius: 4px;
    }

    h1 {
      font-size: 1.5rem;
      color: #003366;
      margin-bottom: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
      font-size: 0.92rem;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem 0.75rem;
      text-align: left;
    }

    th {
      background: #003366;
      color: white;
    }

    tr:nth-child(even) {
      background: #f4f4f4;
    }

    #loader, #error {
      text-align: center;
      font-size: 1rem;
      margin-top: 1rem;
    }

    .retry-btn {
      background: #003366;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="banner">
      üîê Seguran√ßa come√ßa na raiz: contribua pensando em <strong>modelagem de amea√ßas</strong> e <strong>requisitos de seguran√ßa</strong>.  
      üí° Contribua com novos dados via <a href="https://github.com/cnetsec/south-america-cve-hall/pulls" target="_blank">Pull Request</a>.
    </div>

    <h1>üåé Hall de CVEs - Pesquisadores Sul-Americanos</h1>
    <div id="rankings"></div>
    <div id="loader">üîÑ Carregando conte√∫do diretamente do GitHub...</div>
    <div id="content" style="display:none;"></div>
    <div id="error" style="display:none;">
      ‚ùå Erro ao carregar conte√∫do.
      <br>
      <button class="retry-btn" onclick="loadMarkdown()">Tentar novamente</button>
    </div>
  </div>

  <script>
    async function loadMarkdown() {
      document.getElementById("loader").style.display = "block";
      document.getElementById("error").style.display = "none";
      document.getElementById("content").style.display = "none";
      document.getElementById("rankings").innerHTML = "";

      try {
        const res = await fetch("https://raw.githubusercontent.com/cnetsec/south-america-cve-hall/main/README.md");
        if (!res.ok) throw new Error("Erro ao buscar README.md");

        const md = await res.text();
        const html = marked.parse(md);
        document.getElementById("content").innerHTML = html;
        document.getElementById("loader").style.display = "none";
        document.getElementById("content").style.display = "block";

        // Processa rankings
        processRankings(md);

      } catch (err) {
        document.getElementById("loader").style.display = "none";
        document.getElementById("error").style.display = "block";
      }
    }

    function processRankings(text) {
      const countryCount = {};
      const personCount = {};

      const lines = text.split("\n");

      let currentPerson = null;
      const cveRegex = /CVE[-‚Äì‚Äî]?\d{4}[-‚Äì‚Äî]?\d{4,7}/gi;
      const countryRegex = /brasil|brazil|üáßüá∑|argentina|üá¶üá∑|üáµüáæ|üá®üá±|üá∫üáæ|üá®üá¥|üáµüá™|üá™üá®|üáªüá™/gi;

      for (let line of lines) {
        const clean = line.trim();

        if (clean.startsWith("**")) {
          const match = clean.match(/\*\*(.*?)\*\*/);
          if (match) {
            currentPerson = match[1].trim();
            personCount[currentPerson] = 0;
          }
        }

        const cves = [...clean.matchAll(cveRegex)];
        const countries = [...clean.matchAll(countryRegex)];

        if (cves.length > 0 && currentPerson) {
          personCount[currentPerson] += cves.length;
        }

        countries.forEach(match => {
          const key = match[0].toLowerCase().replace(/[^\w]/g, '');
          if (!countryCount[key]) countryCount[key] = 0;
          countryCount[key] += cves.length;
        });
      }

      // Organiza pa√≠ses
      const flagMap = {
        brasil: "üáßüá∑", brazil: "üáßüá∑",
        argentina: "üá¶üá∑",
        paraguay: "üáµüáæ", py: "üáµüáæ",
        chile: "üá®üá±",
        uruguay: "üá∫üáæ",
        colombia: "üá®üá¥",
        peru: "üáµüá™",
        ecuador: "üá™üá®",
        venezuela: "üáªüá™"
      };

      const sortedCountries = Object.entries(countryCount)
        .sort((a,b) => b[1] - a[1])
        .map(([country, count]) => {
          const emoji = flagMap[country] || "";
          return `<tr><td>${emoji} ${country.charAt(0).toUpperCase() + country.slice(1)}</td><td>${count}</td></tr>`;
        });

      const sortedPeople = Object.entries(personCount)
        .sort((a,b) => b[1] - a[1])
        .map(([name, count]) => {
          const medal = count >= 1 ? "" : "";
          return `<tr><td>${name}</td><td>${count}</td></tr>`;
        });

      const html = `
        <h2>üèÅ Ranking por Pa√≠s</h2>
        <table><thead><tr><th>Pa√≠s</th><th>CVEs</th></tr></thead><tbody>
        ${sortedCountries.join('')}
        </tbody></table>

        <h2>üßë‚Äçüíª Ranking por Pesquisador</h2>
        <table><thead><tr><th>Nome</th><th>CVEs</th></tr></thead><tbody>
        ${sortedPeople.join('')}
        </tbody></table>
      `;

      document.getElementById("rankings").innerHTML = html;
    }

    // Load script for marked.js
    const script = document.createElement("script");
    script.src = "https://cdn.jsdelivr.net/npm/marked/marked.min.js";
    script.onload = loadMarkdown;
    document.head.appendChild(script);
  </script>
</body>
</html>
