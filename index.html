<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>🌎 Hall de CVEs - Pesquisadores Sul-Americanos</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #f9f9f9;
      color: #333;
      margin: 0;
      padding: 2rem;
    }
    .container {
      max-width: 1100px;
      margin: auto;
      background: #fff;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.05);
    }
    .security-banner {
      font-size: 0.95rem;
      padding: 0.8rem;
      background-color: #eef4fc;
      border-left: 4px solid #003366;
      margin-bottom: 1.5rem;
    }
    h1 {
      text-align: center;
      color: #003366;
    }
    h2 {
      margin-top: 2rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 0.95rem;
    }
    th, td {
      padding: 0.6rem 0.8rem;
      border: 1px solid #ccc;
      text-align: left;
    }
    th {
      background-color: #003366;
      color: white;
    }
    tr:nth-child(even) {
      background-color: #f4f8ff;
    }
    #loader, #error {
      text-align: center;
      margin: 2rem 0;
    }
    .retry-btn {
      background: #003366;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 1rem;
    }
    .markdown {
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="security-banner">
      🔐 Segurança começa na raiz: contribua pensando em <strong>modelagem de ameaças</strong> e <strong>requisitos de segurança</strong>. Cada CVE ensina algo que pode ser evitado!
      💡 Contribua com novos dados via <a href="https://github.com/cnetsec/south-america-cve-hall/pulls" target="_blank">Pull Request</a>.
    </div>

    <h1>🌎 Hall de CVEs - Pesquisadores Sul-Americanos</h1>
    <div id="loader">🔄 Carregando conteúdo diretamente do GitHub...</div>
    <div id="rankings" style="display:none;">
      <h2>🏁 Ranking por País</h2>
      <table id="countryTable">
        <thead>
          <tr><th>País</th><th>CVEs</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <h2>🧑‍💻 Ranking por Pesquisador</h2>
      <table id="personTable">
        <thead>
          <tr><th>Nome</th><th>CVEs</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="markdown" class="markdown"></div>
    <div id="error" style="display:none;">
      ❌ Erro ao carregar conteúdo.
      <br>
      <button class="retry-btn" onclick="loadContent()">Tentar novamente</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    async function loadContent() {
      const loader = document.getElementById("loader");
      const rankings = document.getElementById("rankings");
      const error = document.getElementById("error");
      const markdown = document.getElementById("markdown");

      loader.style.display = "block";
      rankings.style.display = "none";
      error.style.display = "none";

      try {
        const res = await fetch("https://raw.githubusercontent.com/cnetsec/south-america-cve-hall/main/README.md");
        if (!res.ok) throw new Error("Erro ao buscar o markdown");

        const md = await res.text();
        markdown.innerHTML = marked.parse(md);

        // Coleta e análise de dados
        const countryCount = {};
        const personCount = {};
        const lines = md.split("\n");
        let currentPerson = null;

        const cveRegex = /CVE[-–‐‑‒–—―]?\d{4}[-–‐‑‒–—―]?\d{4,7}/gi;
        const countryRegex = /🇧🇷|🇵🇾|🇺🇾|🇦🇷|🇨🇱|🇧🇴|🇵🇪|🇪🇨|🇻🇪|🇨🇴|🇬🇾|🇸🇷|Brasil|Brazil|Paraguai|Argentina|Uruguai|Chile|Colômbia|Peru|Bolívia|Venezuela|Equador|Suriname|Guiana/gi;

        lines.forEach(line => {
          const cleanLine = line.trim();

          if (cleanLine.startsWith("**") && cleanLine.endsWith("**")) {
            currentPerson = cleanLine.replace(/\*\*/g, "").trim();
            if (!personCount[currentPerson]) personCount[currentPerson] = 0;
          }

          const cves = cleanLine.match(cveRegex);
          const countries = cleanLine.match(countryRegex);

          if (cves && currentPerson) {
            const uniqueCves = [...new Set(cves.map(cve => cve.toUpperCase().replace(/[–—―‐‑]/g, "-")))];
            personCount[currentPerson] += uniqueCves.length;
            if (countries) {
              countries.forEach(c => {
                const key = c.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
                const country = key.includes("brasil") || key.includes("🇧🇷") ? "Brasil"
                              : key.includes("paraguai") || key.includes("🇵🇾") ? "Paraguai"
                              : key.includes("uruguai") || key.includes("🇺🇾") ? "Uruguai"
                              : key.includes("argentina") || key.includes("🇦🇷") ? "Argentina"
                              : key.includes("chile") || key.includes("🇨🇱") ? "Chile"
                              : key.includes("colombia") || key.includes("🇨🇴") ? "Colômbia"
                              : key.includes("venezuela") || key.includes("🇻🇪") ? "Venezuela"
                              : key.includes("equador") || key.includes("🇪🇨") ? "Equador"
                              : key.includes("bolivia") || key.includes("🇧🇴") ? "Bolívia"
                              : key.includes("peru") || key.includes("🇵🇪") ? "Peru"
                              : key.includes("suriname") || key.includes("🇸🇷") ? "Suriname"
                              : key.includes("guiana") || key.includes("🇬🇾") ? "Guiana"
                              : "Outro";
                if (!countryCount[country]) countryCount[country] = 0;
                countryCount[country] += uniqueCves.length;
              });
            }
          }
        });

        const sortedCountries = Object.entries(countryCount).sort((a, b) => b[1] - a[1]);
        const sortedPeople = Object.entries(personCount).sort((a, b) => b[1] - a[1]);

        const countryTable = document.getElementById("countryTable").querySelector("tbody");
        const personTable = document.getElementById("personTable").querySelector("tbody");
        countryTable.innerHTML = "";
        personTable.innerHTML = "";

        sortedCountries.forEach(([name, count]) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${name}</td><td>${count}</td>`;
          countryTable.appendChild(tr);
        });

        sortedPeople.forEach(([name, count]) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${name}</td><td>${count}</td>`;
          personTable.appendChild(tr);
        });

        loader.style.display = "none";
        rankings.style.display = "block";

      } catch (err) {
        console.error(err);
        loader.style.display = "none";
        error.style.display = "block";
      }
    }

    loadContent();
  </script>
</body>
</html>
